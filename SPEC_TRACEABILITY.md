# SPEC_TRACEABILITY

This matrix maps each `REQ-*` in `MASTER_SPEC.md` to implementation evidence in code, tests, and CI.

Legend:
- `implemented`: mapped to code + tests + CI signal.
- `partial`: partially covered; follow-up needed.
- `gap`: not yet implemented; rationale explicitly stated.

| REQ | Code Location(s) | Test(s) | CI Job(s) | Status | Gap / Rationale |
| --- | --- | --- | --- | --- | --- |
| REQ-2.3.1 | `package.json` | `tools/orphan-check.ts` | `node` | implemented | `dependencies` is `{}`. |
| REQ-2.3.2 | `docs/DEVDEPS.md`, `docs/DECISIONS.md`, `package.json` (`devDependencies.miniflare`, `devDependencies.typescript`) | `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts` | `workers`, `browser` | implemented | Dev dependencies are tracked with explicit debt rationale in ADR-0015 and ADR-0017. |
| REQ-2.3.3 | `docs/PORTABILITY.md`, `examples/*`, `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts` | `tests/run.ts`, `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts` | `node`, `deno`, `bun`, `workers`, `browser` | implemented | Required targets are covered and browser compatibility is validated by bundling harness. |
| REQ-4.1.1 | `src/core/*`, `src/providers/*` | `tests/core/*`, `tests/providers/*` | `node`, `deno`, `bun` | implemented | Core uses Web APIs (`fetch`, `crypto.subtle`, streams). |
| REQ-4.1.2 | `src/index.ts`, `src-node/fs.ts`, `package.json` exports | `tests/io/jsonl.test.ts` | `node` | implemented | Node-only fs isolated under `./node` subpath. |
| REQ-4.2.1 | `.github/workflows/ci.yml` | `tests/run.ts` | `node`, `deno`, `bun` | implemented | Multi-runtime CI matrix exists. |
| REQ-4.2.2 | `examples/workers/worker.ts`, `tests/workers/harness.test.ts`, `package.json` (`test:workers`) | `tests/workers/harness.test.ts` | `workers` | implemented | Workers compatibility validated by Miniflare harness in CI. |
| REQ-4.2.3 | `examples/browser/index.html`, `examples/browser/app.ts`, `tests/browser/harness.test.ts`, `package.json` (`test:browser`) | `tests/browser/harness.test.ts` | `browser` | implemented | Browser compatibility is validated by platform-browser bundle harness in CI. |
| REQ-6.1.1 | `src/core/types.ts` (`DocumentInput`), `src/engine/run.ts` (`runWithEvidence`) | `tests/engine/run-with-evidence.test.ts` | `node`, `deno`, `bun` | implemented | Document input is explicit and run through public API. |
| REQ-6.2.1 | `src/core/types.ts` (`Program`, `ProgramInput`), `src/core/program.ts`, `src/engine/run.ts`, `contracts/program.schema.json` | `tests/core/program-shape.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/program-shape-contract.test.ts`, `tests/regression/program-shape-alignment.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Program inputs are normalized to a deterministic structured shape (`programId`, `description`, `classes`, `constraints`) and invalid shapes are rejected with deterministic validation errors. |
| REQ-6.3.1 | `src/schema/s.ts`, `src/schema/validate.ts`, `src/schema/toJsonSchema.ts`, `src/schema/normalizeDialect.ts`, `src/core/program.ts`, `contracts/json-schema-subset.schema.json` | `tests/schema/*`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/json-schema-subset-dialect-guard.test.ts`, `tests/regression/schema-dialect-normalization.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Supported dialect markers are normalized into one canonical JsonSchemaSubset form and unsupported dialect keywords fail deterministically. |
| REQ-6.4.1 | `src/core/types.ts` (`Extraction`), `src/engine/run.ts`, `contracts/extraction.schema.json`, `contracts/evidence-bundle.schema.json` | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/extraction-offsets-contract.test.ts`, `tests/regression/extraction-offsets-alignment.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Extractions require top-level `offsetMode`/`charStart`/`charEnd` with mirrored span and deterministic parser validation for offset-field consistency. |
| REQ-6.5.1 | `src/core/types.ts` (`EvidenceBundle`, `RunDiagnostics`, `ShardOutcome`), `src/engine/run.ts` (`runWithEvidence`), `src/evidence/attest.ts`, `src/evidence/verify.ts`, `contracts/evidence-bundle.schema.json`, `contracts/evidence-attestation.schema.json` | `tests/engine/run-with-evidence.test.ts`, `tests/io/jsonl.test.ts`, `tests/evidence/attestation.test.ts` | `node`, `deno`, `bun` | implemented | Run path emits evidence bundles with provenance, normalization ledger, shard outcomes, and failures; optional attestation provides integrity verification metadata. |
| REQ-7.1.1 | `src/core/invariants.ts`, `src/engine/run.ts` | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts` | `node`, `deno`, `bun` | implemented | Quote invariant enforces supported offset mode, mirrored offset consistency, in-range bounds, and exact quote equality. |
| REQ-7.1.2 | `src/core/invariants.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json` | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/repair-log-in-diagnostics.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Run diagnostics now include typed `repairLog.entries` for success/failure paths with bounded redacted metadata and explicit parse/repair step status. |
| REQ-7.2.1 | `src/core/normalize.ts`, `src/core/types.ts` | `tests/core/normalize.test.ts` | `node`, `deno`, `bun` | partial | Explicit lossy flag exists; reversible mapping currently absent by design. |
| REQ-7.3.1 | `src/providers/*` | `tests/providers/real-providers.test.ts` | `node`, `deno`, `bun` | implemented | Model IDs treated opaquely. |
| REQ-7.4.1 | `src/engine/run.ts` (`runWithEvidence`), `src/core/types.ts`, `contracts/evidence-bundle.schema.json` | `tests/engine/run-with-evidence.test.ts`, `tests/contracts/evidence-bundle-diagnostics-fields.test.ts` | `node`, `deno`, `bun` | implemented | Diagnostics explicitly classify `empty_by_evidence` vs `empty_by_failure` and include machine-readable completeness metadata without silent collapse. |
| REQ-8.1.1 | `src/engine/chunk.ts` | `tests/engine/chunk-map-span.test.ts` | `node`, `deno`, `bun` | implemented | Chunk size, overlap, deterministic IDs. |
| REQ-8.1.2 | `src/engine/chunk.ts`, `src/engine/run.ts`, `src/eval/runSuite.ts` | `tests/engine/chunk-map-span.test.ts`, `tests/providers/fake-e2e.test.ts` | `node`, `deno`, `bun` | implemented | Shard hash input includes documentId, chunkSize, overlap, offsetMode, shard range, and shard text; call sites pass expanded options. |
| REQ-8.2.1 | `src/engine/run.ts`, `src/engine/promptCompiler.ts`, `bench/run.ts`, `contracts/evidence-bundle.schema.json` | `tests/engine/run-with-evidence.test.ts`, `tests/regression/multi-pass-execution-model.test.ts`, `npm run bench` | `node`, `deno`, `bun`, `bench` | implemented | Deterministic shard pipeline now executes fixed stages (`draft`, `validate`, `repair`, `finalize`) with bounded pass count and typed stage diagnostics. |
| REQ-8.3.1 | `src/engine/execute.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json` | `tests/engine/checkpoint-retry-executor.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/executor-evidence-classification.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Runs now expose explicit completeness (`complete_success`, `partial_success`, `complete_failure`) while preserving successful shard extractions unless `allOrNothing` is requested. |
| REQ-8.3.2 | `src/engine/checkpoint.ts`, `src/engine/execute.ts`, `src-node/fs.ts` | `tests/engine/checkpoint-retry-executor.test.ts` | `node`, `deno`, `bun` | implemented | In-memory + node adapter pathways exist. |
| REQ-9.1.1 | `src/providers/types.ts`, `src/providers/fake.ts`, `src/providers/openai.ts`, `src/providers/gemini.ts`, `src/providers/ollama.ts`, `src/engine/run.ts`, `src/schema/normalizeDialect.ts` | `tests/providers/real-providers.test.ts`, `tests/providers/fake-e2e.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/provider-structured-generate-split.test.ts`, `tests/regression/schema-dialect-normalization.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Provider contract splits structured vs text generation, schema-first paths route through `generateStructured`, and provider-bound schemas are dialect-normalized before transport. |
| REQ-9.1.2 | `src/providers/*` | `tests/providers/real-providers.test.ts` | `node`, `deno`, `bun` | implemented | Base URL + header support without model rewriting. |
| REQ-9.2.1 | `src/json/extractJson.ts`, `src/json/frameDecoder.ts`, `src/json/repair.ts`, `src/json/parse.ts`, `src/json/pipeline.ts`, `src/engine/run.ts` | `tests/json/*`, `tests/engine/json-pipeline-run.test.ts`, `tests/regression/streaming-frame-decoder.test.ts` | `node`, `deno`, `bun`, `bench` | implemented | Engine run path decodes streamed frames, then applies bounded extract+repair+strict parse with explicit deterministic parse diagnostics for malformed frames. |
| REQ-9.2.2 | `src/engine/run.ts`, `src/core/types.ts`, `src/json/repair.ts`, `src/json/pipeline.ts`, `contracts/evidence-bundle.schema.json`, `contracts/repair-log.schema.json` | `tests/engine/run-with-evidence.test.ts`, `tests/json/repair.test.ts` | `node`, `deno`, `bun` | implemented | Run path surfaces explicit time, retry, and repair caps through `RunBudgets` + `diagnostics.budgetLog`, including deterministic budget-exhaustion failure signaling. |
| REQ-10.1 | `src/engine/promptCompiler.ts`, `src/providers/*`, `docs/THREAT_MODEL.md`, `docs/SECURE_INTEGRATION.md` | `tests/engine/prompt-compiler.test.ts` | `node`, `deno`, `bun` | partial | Unsafe execution paths are absent in library code; downstream allowlist controls are documented for integrators. |
| REQ-10.2 | `src/engine/promptCompiler.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json` | `tests/engine/prompt-compiler.test.ts`, `tests/engine/run-with-evidence.test.ts` | `node`, `deno`, `bun` | implemented | Safe interpolation helper and prompt hashing are explicit APIs, and run diagnostics now include `promptLog` with program and per-shard prompt hashes. |
| REQ-10.3 | `src/viz/html.ts` | `tests/viz/html.test.ts` | `node`, `deno`, `bun` | implemented | HTML escaping is default behavior. |
| REQ-11.1.1 | `src/core/*`, `src/engine/*`, `src/json/*`, `src/providers/*` | `tests/core/*`, `tests/engine/*`, `tests/json/*`, `tests/providers/*` | `node`, `deno`, `bun` | partial | Model-id opacity and parser tolerance covered; property tests not yet present. |
| REQ-11.2.1 | `src/eval/runSuite.ts`, `bench/run.ts`, `bench/score.ts`, `bench/datasets/smoke.jsonl` | `tests/eval/run-suite.test.ts`, `npm run bench` | `node`, `bench` | partial | Deterministic and trial-based variance metrics are implemented; provider/temperature/prompt-variant breadth remains limited. |
| REQ-11.3.1 | `tests/fixtures/long-document.txt`, `tests/engine/long-text-fixture.test.ts`, `bench/datasets/smoke.jsonl` | `tests/engine/long-text-fixture.test.ts`, `npm run bench` | `node`, `deno`, `bun`, `bench` | implemented | Deterministic long-text fixtures validate chunking stability, span mapping stability, quote invariant enforcement, and bench scoring. |
| REQ-12.1 | GitHub PR workflow + branch protections (process) | n/a | `pull_request` workflows | implemented | Enforced by process in this repository workflow. |
| REQ-12.2 | `.github/workflows/ci.yml`, `.github/dependabot.yml`, `tools/oss-check.ts`, `tools/pr-body-check.ts` | CI status checks, `npm run oss-check` | `node`, `deno`, `bun`, `workers`, `browser`, `bench` | implemented | CI runs on `pull_request`, uses least-privilege permissions, pins actions by SHA, enforces Dependabot `open-pull-requests-limit: 0`, and validates pull request body headings in the `node` job. |
| REQ-12.3 | `tools/orphan-check.ts`, `tools/oss-check.ts`, `tools/repo-scope-check.ts`, `tools/repo-text-check.ts`, `.github/PULL_REQUEST_TEMPLATE.md`, `docs/OSS_PRACTICES.md`, `docs/REPO_SCOPE.md`, `package.json` (`check`) | `npm run repo-scope-check`, `npm run repo-text-check`, `npm run orphan-check`, `npm run oss-check` | `node` | implemented | Export/contract/doc coherence, repository scope controls, and semantic identifier policy checks are enforced in default validation, including PR template presence. |
| REQ-13.1 | `LICENSE`, `NOTICE` | n/a | n/a | implemented | Apache-2.0 license text and project notice are present at repo root. |
| REQ-14.1 | `src/*`, `src-node/*`, `contracts/*`, `docs/*`, `tests/*`, `tools/*` | `npm run orphan-check` | `node` | partial | Layout is close; differs from exact `/src/node` and `/scripts` naming convention. |

## Explicit Known Gaps

These gaps are intentionally tracked and should be resolved in follow-up implementation work:
