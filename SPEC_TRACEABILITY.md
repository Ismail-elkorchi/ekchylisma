# SPEC_TRACEABILITY

This matrix maps each `REQ-*` in `MASTER_SPEC.md` to implementation evidence in
code, tests, and CI.

Legend:

- `implemented`: mapped to code + tests + CI signal.
- `partial`: partially covered; follow-up needed.
- `gap`: not yet implemented; rationale explicitly stated.

| REQ        | Code Location(s)                                                                                                                                                                                                                                             | Test(s)                                                                                                                                                                                                                                                                                                                                                          | CI Job(s)                                            | Status      | Gap / Rationale                                                                                                                                                                                                                                      |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| REQ-2.3.1  | `package.json`                                                                                                                                                                                                                                               | n/a                                                                                                                                                                                                                                                                                                                                                              | `node`                                               | implemented | `dependencies` is `{}`.                                                                                                                                                                                                                              |
| REQ-2.3.2  | `docs/DEVDEPS.md`, `docs/DECISIONS.md`, `package.json` (`devDependencies.miniflare`, `devDependencies.typescript`)                                                                                                                                           | `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts`                                                                                                                                                                                                                                                                                                 | `workers`, `browser`                                 | implemented | Dev dependencies are tracked with explicit debt rationale in ADR-0015 and ADR-0017.                                                                                                                                                                  |
| REQ-2.3.3  | `docs/PORTABILITY.md`, `examples/*`, `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts`                                                                                                                                                        | `tests/run.ts`, `tests/workers/harness.test.ts`, `tests/browser/harness.test.ts`                                                                                                                                                                                                                                                                                 | `node`, `deno`, `bun`, `workers`, `browser`          | implemented | Required targets are covered and browser compatibility is validated by bundling harness.                                                                                                                                                             |
| REQ-4.1.1  | `src/core/*`, `src/providers/*`                                                                                                                                                                                                                              | `tests/core/*`, `tests/providers/*`                                                                                                                                                                                                                                                                                                                              | `node`, `deno`, `bun`                                | implemented | Core uses Web APIs (`fetch`, `crypto.subtle`, streams).                                                                                                                                                                                              |
| REQ-4.1.2  | `src/index.ts`, `src/node/fs.ts`, `package.json` exports                                                                                                                                                                                                     | `tests/io/jsonl.test.ts`                                                                                                                                                                                                                                                                                                                                         | `node`                                               | implemented | Node-only fs isolated under `./node` subpath.                                                                                                                                                                                                        |
| REQ-4.2.1  | `.github/workflows/ci.yml`                                                                                                                                                                                                                                   | `tests/run.ts`                                                                                                                                                                                                                                                                                                                                                   | `node`, `deno`, `bun`                                | implemented | Multi-runtime CI matrix exists.                                                                                                                                                                                                                      |
| REQ-4.2.2  | `examples/workers/worker.ts`, `tests/workers/harness.test.ts`, `package.json` (`test:workers`)                                                                                                                                                               | `tests/workers/harness.test.ts`                                                                                                                                                                                                                                                                                                                                  | `workers`                                            | implemented | Workers compatibility validated by Miniflare harness in CI.                                                                                                                                                                                          |
| REQ-4.2.3  | `examples/browser/index.html`, `examples/browser/app.ts`, `tests/browser/harness.test.ts`, `package.json` (`test:browser`)                                                                                                                                   | `tests/browser/harness.test.ts`                                                                                                                                                                                                                                                                                                                                  | `browser`                                            | implemented | Browser compatibility is validated by platform-browser bundle harness in CI.                                                                                                                                                                         |
| REQ-6.1.1  | `src/core/types.ts` (`DocumentInput`), `src/engine/run.ts` (`runWithEvidence`)                                                                                                                                                                               | `tests/engine/run-with-evidence.test.ts`                                                                                                                                                                                                                                                                                                                         | `node`, `deno`, `bun`                                | implemented | Document input is explicit and run through public API.                                                                                                                                                                                               |
| REQ-6.2.1  | `src/core/types.ts` (`Program`, `ProgramInput`), `src/core/program.ts`, `src/engine/run.ts`, `contracts/program.schema.json`                                                                                                                                 | `tests/core/program-shape.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/program-shape-contract.test.ts`, `tests/regression/program-shape-alignment.test.ts`                                                                                                                                                                               | `node`, `deno`, `bun`, `bench`                       | implemented | Program inputs are normalized to a deterministic structured shape (`programId`, `description`, `classes`, `constraints`) and invalid shapes are rejected with deterministic validation errors.                                                       |
| REQ-6.3.1  | `src/schema/schemaCue.ts`, `src/schema/validate.ts`, `src/schema/toJsonSchema.ts`, `src/schema/normalizeDialect.ts`, `src/core/program.ts`, `contracts/json-schema-subset.schema.json`                                                                       | `tests/schema/*`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/json-schema-subset-dialect-guard.test.ts`, `tests/regression/schema-dialect-normalization.test.ts`                                                                                                                                                                                  | `node`, `deno`, `bun`, `bench`                       | implemented | Supported dialect markers are normalized into one canonical JsonSchemaSubset form and unsupported dialect keywords fail deterministically.                                                                                                           |
| REQ-6.4.1  | `src/core/types.ts` (`Extraction`), `src/engine/run.ts`, `contracts/extraction.schema.json`, `contracts/evidence-bundle.schema.json`                                                                                                                         | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/extraction-offsets-contract.test.ts`, `tests/regression/extraction-offsets-alignment.test.ts`                                                                                                                                                                        | `node`, `deno`, `bun`, `bench`                       | implemented | Extractions require top-level `offsetMode`/`charStart`/`charEnd` with mirrored span and deterministic parser validation for offset-field consistency.                                                                                                |
| REQ-6.5.1  | `src/core/types.ts` (`EvidenceBundle`, `RunDiagnostics`, `ShardOutcome`), `src/engine/run.ts` (`runWithEvidence`), `src/evidence/attest.ts`, `src/evidence/verify.ts`, `contracts/evidence-bundle.schema.json`, `contracts/evidence-attestation.schema.json` | `tests/engine/run-with-evidence.test.ts`, `tests/io/jsonl.test.ts`, `tests/evidence/attestation.test.ts`                                                                                                                                                                                                                                                         | `node`, `deno`, `bun`                                | implemented | Run path emits evidence bundles with provenance, normalization ledger, shard outcomes, and failures; optional attestation provides integrity verification metadata.                                                                                  |
| REQ-7.1.1  | `src/core/invariants.ts`, `src/engine/run.ts`                                                                                                                                                                                                                | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts`                                                                                                                                                                                                                                                                                        | `node`, `deno`, `bun`                                | implemented | Quote invariant enforces supported offset mode, mirrored offset consistency, in-range bounds, and exact quote equality.                                                                                                                              |
| REQ-7.1.2  | `src/core/invariants.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json`                                                                                                                                                  | `tests/core/invariants.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/repair-log-in-diagnostics.test.ts`                                                                                                                                                                                                                                  | `node`, `deno`, `bun`, `bench`                       | implemented | Run diagnostics now include typed `repairLog.entries` for success/failure paths with bounded redacted metadata and explicit parse/repair step status.                                                                                                |
| REQ-7.2.1  | `src/core/normalize.ts`, `src/core/types.ts`                                                                                                                                                                                                                 | `tests/core/normalize.test.ts`                                                                                                                                                                                                                                                                                                                                   | `node`, `deno`, `bun`                                | implemented | Normalization steps explicitly declare non-reversible behavior and lossy status (`mappingStrategy`, `lossy`) in the ledger, satisfying the explicit non-reversible-path requirement.                                                                 |
| REQ-7.3.1  | `src/providers/*`                                                                                                                                                                                                                                            | `tests/providers/real-providers.test.ts`                                                                                                                                                                                                                                                                                                                         | `node`, `deno`, `bun`                                | implemented | Model IDs treated opaquely.                                                                                                                                                                                                                          |
| REQ-7.4.1  | `src/engine/run.ts` (`runWithEvidence`), `src/core/types.ts`, `contracts/evidence-bundle.schema.json`                                                                                                                                                        | `tests/engine/run-with-evidence.test.ts`, `tests/contracts/evidence-bundle-diagnostics-fields.test.ts`                                                                                                                                                                                                                                                           | `node`, `deno`, `bun`                                | implemented | Diagnostics explicitly classify `empty_by_evidence` vs `empty_by_failure` and include machine-readable completeness metadata without silent collapse.                                                                                                |
| REQ-8.1.1  | `src/engine/chunk.ts`                                                                                                                                                                                                                                        | `tests/engine/chunk-map-span.test.ts`                                                                                                                                                                                                                                                                                                                            | `node`, `deno`, `bun`                                | implemented | Chunk size, overlap, deterministic IDs.                                                                                                                                                                                                              |
| REQ-8.1.2  | `src/engine/chunk.ts`, `src/engine/run.ts`, `src/eval/runSuite.ts`                                                                                                                                                                                           | `tests/engine/chunk-map-span.test.ts`, `tests/providers/fake-e2e.test.ts`                                                                                                                                                                                                                                                                                        | `node`, `deno`, `bun`                                | implemented | Shard hash input includes documentId, chunkSize, overlap, offsetMode, shard range, and shard text; call sites pass expanded options.                                                                                                                 |
| REQ-8.2.1  | `src/engine/run.ts`, `src/engine/promptCompiler.ts`, `bench/run.ts`, `contracts/evidence-bundle.schema.json`                                                                                                                                                 | `tests/engine/run-with-evidence.test.ts`, `tests/regression/multi-pass-execution-model.test.ts`, `npm run bench`                                                                                                                                                                                                                                                 | `node`, `deno`, `bun`, `bench`                       | implemented | Deterministic shard pipeline now executes fixed stages (`draft`, `validate`, `repair`, `finalize`) with bounded pass count and typed stage diagnostics.                                                                                              |
| REQ-8.3.1  | `src/engine/execute.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json`                                                                                                                                                   | `tests/engine/checkpoint-retry-executor.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/executor-evidence-classification.test.ts`                                                                                                                                                                                                          | `node`, `deno`, `bun`, `bench`                       | implemented | Runs now expose explicit completeness (`complete_success`, `partial_success`, `complete_failure`) while preserving successful shard extractions unless `allOrNothing` is requested.                                                                  |
| REQ-8.3.2  | `src/engine/checkpoint.ts`, `src/engine/execute.ts`, `src/node/fs.ts`                                                                                                                                                                                        | `tests/engine/checkpoint-retry-executor.test.ts`                                                                                                                                                                                                                                                                                                                 | `node`, `deno`, `bun`                                | implemented | In-memory + node adapter pathways exist.                                                                                                                                                                                                             |
| REQ-9.1.1  | `src/providers/types.ts`, `src/providers/fake.ts`, `src/providers/openai.ts`, `src/providers/gemini.ts`, `src/providers/ollama.ts`, `src/engine/run.ts`, `src/schema/normalizeDialect.ts`, `contracts/provider-response.schema.json`                         | `tests/providers/real-providers.test.ts`, `tests/providers/fake-e2e.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/provider-response-channel-contract.test.ts`, `tests/regression/provider-structured-generate-split.test.ts`, `tests/regression/tool-call-first-parsing.test.ts`, `tests/regression/schema-dialect-normalization.test.ts` | `node`, `deno`, `bun`, `bench`                       | implemented | Provider contract splits structured vs text generation, surfaces deterministic response channel metadata, and prioritizes tool-call argument payloads before text fallback.                                                                          |
| REQ-9.1.2  | `src/providers/*`                                                                                                                                                                                                                                            | `tests/providers/real-providers.test.ts`                                                                                                                                                                                                                                                                                                                         | `node`, `deno`, `bun`                                | implemented | Base URL + header support without model rewriting.                                                                                                                                                                                                   |
| REQ-9.2.1  | `src/json/extractJson.ts`, `src/json/frameDecoder.ts`, `src/json/repair.ts`, `src/json/parse.ts`, `src/json/pipeline.ts`, `src/engine/run.ts`                                                                                                                | `tests/json/*`, `tests/engine/json-pipeline-run.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/regression/streaming-frame-decoder.test.ts`, `tests/regression/tool-call-first-parsing.test.ts`                                                                                                                                                       | `node`, `deno`, `bun`, `bench`                       | implemented | Engine run path prioritizes tool-call/structured envelopes, decodes streamed frames, and then applies bounded extract+repair+strict parse with deterministic malformed-input diagnostics.                                                            |
| REQ-9.2.2  | `src/engine/run.ts`, `src/core/types.ts`, `src/json/repair.ts`, `src/json/pipeline.ts`, `contracts/evidence-bundle.schema.json`, `contracts/repair-log.schema.json`                                                                                          | `tests/engine/run-with-evidence.test.ts`, `tests/json/repair.test.ts`                                                                                                                                                                                                                                                                                            | `node`, `deno`, `bun`                                | implemented | Run path surfaces explicit time, retry, and repair caps through `RunBudgets` + `diagnostics.budgetLog`, including deterministic budget-exhaustion failure signaling.                                                                                 |
| REQ-10.1   | `src/engine/promptCompiler.ts`, `src/engine/run.ts`, `src/schema/normalizeDialect.ts`, `src/providers/*`, `docs/THREAT_MODEL.md`, `docs/SECURE_INTEGRATION.md`                                                                                               | `tests/engine/prompt-compiler.test.ts`, `tests/engine/security-hardening.test.ts`, `tests/regression/threat-model-hardening.test.ts`                                                                                                                                                                                                                             | `node`, `deno`, `bun`, `bench`                       | implemented | Prompt/repair boundary tokens are neutralized in untrusted sections, schema-confusion payloads are rejected deterministically, and quote-spoofing is enforced as explicit failure with executable regression coverage for documented attack classes. |
| REQ-10.2   | `src/engine/promptCompiler.ts`, `src/engine/run.ts`, `src/core/types.ts`, `contracts/evidence-bundle.schema.json`                                                                                                                                            | `tests/engine/prompt-compiler.test.ts`, `tests/engine/run-with-evidence.test.ts`                                                                                                                                                                                                                                                                                 | `node`, `deno`, `bun`                                | implemented | Safe interpolation helper and prompt hashing are explicit APIs, and run diagnostics now include `promptLog` with program and per-shard prompt hashes.                                                                                                |
| REQ-10.3   | `src/viz/html.ts`                                                                                                                                                                                                                                            | `tests/viz/html.test.ts`                                                                                                                                                                                                                                                                                                                                         | `node`, `deno`, `bun`                                | implemented | HTML escaping is default behavior.                                                                                                                                                                                                                   |
| REQ-11.1.1 | `src/core/prng.ts`, `src/core/hash.ts`, `src/core/invariants.ts`, `src/engine/chunk.ts`, `src/engine/mapSpan.ts`                                                                                                                                             | `tests/core/property-invariants.test.ts`, `tests/core/hash.test.ts`, `tests/core/invariants.test.ts`, `tests/engine/chunk-map-span.test.ts`, `tests/regression/property-based-core-invariants.test.ts`                                                                                                                                                           | `node`, `deno`, `bun`, `bench`                       | implemented | Seeded deterministic property tests now cover hash determinism, quote/offset invariant stability, shard-id determinism, and span-mapping stability with reproducible generated inputs.                                                               |
| REQ-11.2.1 | `src/eval/runSuite.ts`, `bench/run.ts`, `bench/score.ts`, `bench/datasets/smoke.jsonl`, `bench/datasets/regression.jsonl`                                                                                                                                    | `tests/eval/run-suite.test.ts`, `tests/eval/run-suite-breadth-variance.test.ts`, `tests/bench/bench-score-variance.test.ts`, `tests/regression/eval-suite-breadth-and-variance.test.ts`, `npm run bench`                                                                                                                                                         | `node`, `deno`, `bun`, `bench`                       | implemented | Eval and bench now expose breadth metrics (case/category coverage) plus variance drift metrics (`successRateStdDev`, `caseOutcomeDriftRate`) with configurable score thresholds to detect regressions without brittle exact-output overfitting.      |
| REQ-11.3.1 | `tests/fixtures/long-document.txt`, `tests/engine/long-text-fixture.test.ts`, `bench/datasets/smoke.jsonl`                                                                                                                                                   | `tests/engine/long-text-fixture.test.ts`, `npm run bench`                                                                                                                                                                                                                                                                                                        | `node`, `deno`, `bun`, `bench`                       | implemented | Deterministic long-text fixtures validate chunking stability, span mapping stability, quote invariant enforcement, and bench scoring.                                                                                                                |
| REQ-11.4.1 | `src/json/frameDecoder.ts`, `src/json/pipeline.ts`, `src/engine/run.ts`                                                                                                                                                                                      | `tests/json/frame-decoder.test.ts`, `tests/engine/json-pipeline-run.test.ts`, `tests/regression/streaming-frame-decoder.test.ts`                                                                                                                                                                                                                                 | `node`, `deno`, `bun`, `bench`                       | implemented | Stream/frame decoding is validated through unit, pipeline, and regression coverage, including deterministic malformed-frame diagnostics.                                                                                                             |
| REQ-11.4.2 | `src/providers/openai.ts`, `src/providers/gemini.ts`, `src/providers/ollama.ts`, `src/engine/run.ts`, `contracts/provider-response.schema.json`                                                                                                              | `tests/providers/real-providers.test.ts`, `tests/engine/run-with-evidence.test.ts`, `tests/contracts/provider-response-channel-contract.test.ts`, `tests/regression/tool-call-first-parsing.test.ts`                                                                                                                                                             | `node`, `deno`, `bun`, `bench`                       | implemented | Tool-call framing paths are exercised across provider adapters and run-path tests, with deterministic fallback behavior validated by regression coverage.                                                                                            |
| REQ-12.1   | GitHub PR workflow + branch protections (process)                                                                                                                                                                                                            | n/a                                                                                                                                                                                                                                                                                                                                                              | `pull_request` workflows                             | implemented | Enforced by process in this repository workflow.                                                                                                                                                                                                     |
| REQ-12.2   | `.github/workflows/ci.yml`, `.github/dependabot.yml`, `tools/pr-body-check.ts`, `scripts/pr-body-check.ts`                                                                                                                                                   | `tests/tools/pr-check-rejects-placeholder-title.test.ts`, `tests/tools/pr-check-rejects-placeholder-branch.test.ts`, CI status checks                                                                                                                                                                                                                            | `node`, `deno`, `bun`, `workers`, `browser`, `bench` | implemented | CI runs on `pull_request`, uses least-privilege permissions, pins actions by SHA, enforces Dependabot `open-pull-requests-limit: 0`, and validates pull request body headings plus pull request title/branch naming policy in the `node` job.        |
| REQ-12.3   | `scripts/repo-scope-check.ts`, `scripts/repo-text-check.ts`, `tools/repo-scope-check.ts`, `tools/repo-text-check.ts`, `.github/PULL_REQUEST_TEMPLATE.md`, `docs/OSS_PRACTICES.md`, `docs/REPO_SCOPE.md`, `package.json` (`check`)                            | `npm run repo-scope-check`, `npm run repo-text-check`, `tests/tools/repo-scope-check.test.ts`, `tests/tools/repo-text-check-placeholders.test.ts`, `tests/tools/repo-text-check-boundaries.test.ts`, `tests/tools/repo-text-check-unicode-format-controls.test.ts`, `tests/bench/regression-jsonl-newline-integrity.test.ts`                                     | `node`                                               | implemented | Repository scope controls, text safety controls for hidden Unicode format-control characters and JSONL linebreak integrity, and semantic identifier checks are enforced in default validation.                                                       |
| REQ-12.4.1 | `.github/workflows/release.yml`, `docs/RELEASE.md`                                                                                                                                                                                                           | `tests/ci/release-workflow-pinning.test.ts`                                                                                                                                                                                                                                                                                                                      | `release`, `node`                                    | implemented | Version tags matching `v*.*.*` trigger artifact packaging (`npm pack`) and upload of tarball, compiled output, `contracts/`, and `docs/RELEASE.md`, with pinned-action enforcement in workflow tests.                                                |
| REQ-13.1   | `LICENSE`, `NOTICE`                                                                                                                                                                                                                                          | n/a                                                                                                                                                                                                                                                                                                                                                              | n/a                                                  | implemented | Apache-2.0 license text and project notice are present at repo root.                                                                                                                                                                                 |
| REQ-14.1   | `src/core/*`, `src/engine/*`, `src/node/*`, `contracts/*`, `docs/*`, `tests/*`, `scripts/*`                                                                                                                                                                  | `tests/layout/layout-alignment-and-portability.test.ts`, `tests/regression/layout-alignment-and-portability.test.ts`, `npm run check`, `npm run test:deno`, `npm run test:bun`, `npm run test:workers`, `npm run test:browser`                                                                                                                                   | `node`, `deno`, `bun`, `workers`, `browser`          | implemented | Repository layout now includes canonical `src/node` and `scripts` directories, package/CI wiring is aligned to those paths, and portability checks remain green across runtime targets.                                                              |

## Explicit Known Gaps

These gaps are intentionally tracked and should be resolved in follow-up
implementation work:
